<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>UK Macro Master</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #007AFF; --success: #34c759; --pro: #5856d6; --carb: #ff9500; --fat: #ff3b30; --bg: #f2f2f7; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #1c1c1e; padding-bottom: 50px; }
        .card { background: white; border-radius: 16px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h2, h3 { margin: 0 0 15px 0; font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; }
        .goal-row { margin-bottom: 12px; }
        .goal-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; font-weight: 600; }
        .bar-bg { background: #e5e5ea; height: 8px; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.8s ease; }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; background: #000; margin-bottom: 15px; }
        .input-group { display: flex; gap: 8px; }
        input { padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; width: 100%; }
        #result-popup { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 25px; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 25px rgba(0,0,0,0.2); z-index: 1000; }
        .btn { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-sec { background: #e5e5ea; color: #333; }
        .item-log { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f2f2f7; font-size: 13px; }
        .history-day { font-size: 12px; padding: 10px 0; border-bottom: 1px solid #eee; }
        .edit-btn { font-size: 12px; color: var(--primary); font-weight: normal; }
    </style>
</head>
<body>

    <div class="card">
        <h2 id="current-date">Today <span class="edit-btn" onclick="editGoals()">Goals</span></h2>
        <div class="goal-row">
            <div class="goal-label"><span>Calories</span><span id="txt-cal">0/2000</span></div>
            <div class="bar-bg"><div id="bar-cal" class="bar-fill" style="background:var(--success)"></div></div>
        </div>
        <div class="goal-row">
            <div class="goal-label"><span>Protein</span><span id="txt-pro">0/50g</span></div>
            <div class="bar-bg"><div id="bar-pro" class="bar-fill" style="background:var(--pro)"></div></div>
        </div>
        <div class="goal-row">
            <div class="goal-label"><span>Carbs</span><span id="txt-carb">0/260g</span></div>
            <div class="bar-bg"><div id="bar-carb" class="bar-fill" style="background:var(--carb)"></div></div>
        </div>
        <div class="goal-row">
            <div class="goal-label"><span>Fat</span><span id="txt-fat">0/70g</span></div>
            <div class="bar-bg"><div id="bar-fat" class="bar-fill" style="background:var(--fat)"></div></div>
        </div>
    </div>

    <div id="reader"></div>

    <div class="card">
        <h3>Quick Add</h3>
        <div class="input-group">
            <input type="text" id="m-name" placeholder="Name">
            <input type="number" id="m-cal" placeholder="Cals" style="width:70px">
            <button class="btn" onclick="manualAdd()" style="margin:0; width:50px">+</button>
        </div>
    </div>

    <div class="card">
        <h3>Logged Items</h3>
        <div id="food-list"></div>
    </div>

    <div class="card">
        <h3>7-Day History</h3>
        <div id="history-list"></div>
        <button class="btn btn-sec" style="font-size:10px; margin-top:15px;" onclick="if(confirm('Wipe everything?')){localStorage.clear(); location.reload();}">Hard Reset</button>
    </div>

    <div id="result-popup">
        <h3 id="pop-name">Product</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:15px 0; font-size:13px;">
            <div style="background:#f9f9f9; padding:8px; border-radius:8px;">üî• <b id="val-cal">0</b> kcal</div>
            <div style="background:#f9f9f9; padding:8px; border-radius:8px;">üí™ P: <b id="val-pro">0</b>g</div>
            <div style="background:#f9f9f9; padding:8px; border-radius:8px;">üçû C: <b id="val-carb">0</b>g</div>
            <div style="background:#f9f9f9; padding:8px; border-radius:8px;">ü•ë F: <b id="val-fat">0</b>g</div>
        </div>
        <label style="font-size:12px; font-weight:bold;">Multiplier (1 = 100g or 1 pack):</label>
        <input type="number" id="weight-mult" value="1" step="0.1">
        <button class="btn" id="add-btn">Add to Diary</button>
        <button class="btn btn-sec" onclick="document.getElementById('result-popup').style.display='none'">Cancel</button>
    </div>

    <script>
        const today = new Date().toLocaleDateString('en-GB');
        document.getElementById('current-date').prepend(today + " ");
        
        let log = JSON.parse(localStorage.getItem('ukLog')) || {}; 
        let goals = JSON.parse(localStorage.getItem('ukGoals')) || { cal: 2000, pro: 50, carb: 260, fat: 70 };

        if (!log[today]) log[today] = { cal: 0, pro: 0, carb: 0, fat: 0, items: [] };

        function updateUI() {
            const cur = log[today];
            const updateBar = (id, val, goal) => {
                document.getElementById(`txt-${id}`).innerText = `${Math.round(val)} / ${goal}${id==='cal'?'':'g'}`;
                document.getElementById(`bar-${id}`).style.width = Math.min((val / goal) * 100, 100) + '%';
            };
            
            updateBar('cal', cur.cal, goals.cal);
            updateBar('pro', cur.pro, goals.pro);
            updateBar('carb', cur.carb, goals.carb);
            updateBar('fat', cur.fat, goals.fat);
            
            document.getElementById('food-list').innerHTML = cur.items.slice(-5).reverse().map(i => `
                <div class="item-log"><span>${i.name}</span><b>${Math.round(i.cal)} kcal</b></div>
            `).join('');

            const historyHTML = Object.keys(log).sort().reverse().slice(1, 8).map(date => `
                <div class="history-day">
                    <b>${date}</b>: ${Math.round(log[date].cal)}cal | P:${Math.round(log[date].pro)}g | C:${Math.round(log[date].carb)}g | F:${Math.round(log[date].fat)}g
                </div>
            `).join('');
            document.getElementById('history-list').innerHTML = historyHTML || '<p style="color:gray;font-size:11px;">History starts tomorrow!</p>';
        }

        function editGoals() {
            goals.cal = prompt("Calories:", goals.cal);
            goals.pro = prompt("Protein (g):", goals.pro);
            goals.carb = prompt("Carbs (g):", goals.carb);
            goals.fat = prompt("Fat (g):", goals.fat);
            localStorage.setItem('ukGoals', JSON.stringify(goals));
            updateUI();
        }

        function manualAdd() {
            const name = document.getElementById('m-name').value || "Quick Add";
            const cal = parseFloat(document.getElementById('m-cal').value) || 0;
            if(cal > 0) {
                log[today].cal += cal;
                log[today].items.push({name, cal});
                localStorage.setItem('ukLog', JSON.stringify(log));
                updateUI();
                document.getElementById('m-name').value = ''; document.getElementById('m-cal').value = '';
            }
        }

        const scanner = new Html5QrcodeScanner("reader", { 
            fps: 20, qrbox: { width: 250, height: 150 },
            videoConstraints: { facingMode: "environment", focusMode: "continuous" }
        });

        scanner.render(async (barcode) => {
            const res = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}?fields=product_name,nutriments`);
            const data = await res.json();
            if (data.status === 1) {
                const p = data.product;
                const n = p.nutriments;
                document.getElementById('result-popup').style.display = 'block';
                document.getElementById('pop-name').innerText = p.product_name || "Unknown";
                
                const vals = {
                    cal: n['energy-kcal_100g'] || 0,
                    pro: n.proteins_100g || 0,
                    carb: n.carbohydrates_100g || 0,
                    fat: n.fat_100g || 0
                };

                document.getElementById('val-cal').innerText = Math.round(vals.cal);
                document.getElementById('val-pro').innerText = vals.pro;
                document.getElementById('val-carb').innerText = vals.carb;
                document.getElementById('val-fat').innerText = vals.fat;

                document.getElementById('add-btn').onclick = () => {
                    const m = parseFloat(document.getElementById('weight-mult').value) || 1;
                    log[today].cal += (vals.cal * m);
                    log[today].pro += (vals.pro * m);
                    log[today].carb += (vals.carb * m);
                    log[today].fat += (vals.fat * m);
                    log[today].items.push({name: p.product_name, cal: (vals.cal * m)});
                    localStorage.setItem('ukLog', JSON.stringify(log));
                    updateUI();
                    document.getElementById('result-popup').style.display = 'none';
                    document.getElementById('weight-mult').value = 1;
                };
            }
        });
        updateUI();
    </script>
</body>
</html>
