<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>UK Pro Tracker</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #007AFF; --success: #34c759; --bg: #f2f2f7; --card: #ffffff; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #1c1c1e; padding-bottom: 100px; }
        .card { background: var(--card); border-radius: 16px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h2 { margin: 0 0 15px 0; font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; }
        
        /* Progress Bars */
        .goal-row { margin-bottom: 12px; }
        .goal-label { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; font-weight: 600; }
        .bar-bg { background: #e5e5ea; height: 10px; border-radius: 5px; overflow: hidden; }
        .bar-fill { background: var(--success); height: 100%; width: 0%; transition: width 0.8s ease; }
        
        /* Scanner & Inputs */
        #reader { width: 100%; border-radius: 12px; overflow: hidden; background: #000; }
        .input-group { display: flex; gap: 10px; margin-top: 10px; }
        input { padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; width: 100%; }
        
        /* Popup */
        #result-popup { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 25px; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 25px rgba(0,0,0,0.2); z-index: 1000; }
        .btn { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-sec { background: #e5e5ea; color: #333; }
        
        .history-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f2f2f7; font-size: 14px; }
        .edit-goal { font-size: 10px; color: var(--primary); text-transform: uppercase; cursor: pointer; }
    </style>
</head>
<body>

    <div class="card">
        <h2>ðŸ‡¬ðŸ‡§ Daily Dashboard <span class="edit-goal" onclick="editGoals()">Edit Goals</span></h2>
        <div class="goal-row">
            <div class="goal-label"><span>Calories</span><span id="txt-cal">0/2000</span></div>
            <div class="bar-bg"><div id="bar-cal" class="bar-fill"></div></div>
        </div>
        <div class="goal-row">
            <div class="goal-label"><span>Protein (g)</span><span id="txt-pro">0/50</span></div>
            <div class="bar-bg"><div id="bar-pro" class="bar-fill" style="background:#5856d6"></div></div>
        </div>
    </div>

    <div id="reader" class="card"></div>

    <div class="card">
        <h3>Quick Add (No Barcode)</h3>
        <div class="input-group">
            <input type="text" id="manual-name" placeholder="Item Name">
            <input type="number" id="manual-cal" placeholder="Cals" style="width: 80px;">
            <button class="btn" onclick="manualAdd()" style="margin:0; width: 60px;">Add</button>
        </div>
    </div>

    <div class="card">
        <h3>Today's Log</h3>
        <div id="history-list"></div>
        <button class="btn btn-sec" onclick="if(confirm('Reset Day?')){localStorage.clear(); location.reload();}" style="font-size:12px; margin-top:20px;">Reset Everything</button>
    </div>

    <div id="result-popup">
        <h3 id="pop-name" style="margin:0">Product</h3>
        <p id="pop-brand" style="color:gray; margin:5px 0 15px 0"></p>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px; font-size:14px;">
            <div>ðŸ”¥ <b id="val-cal">0</b> kcal</div>
            <div>ðŸ’ª <b id="val-pro">0</b>g Pro</div>
        </div>
        <div style="margin-bottom:15px;">
            <label style="font-size:12px; font-weight:bold;">Portion Size (e.g. 0.5 for half, 2 for double):</label>
            <input type="number" id="weight-mult" value="1" step="0.1" style="margin-top:5px;">
        </div>
        <button class="btn" id="add-btn">Add to Diary</button>
        <button class="btn btn-sec" onclick="document.getElementById('result-popup').style.display='none'">Cancel</button>
    </div>

    <script>
        let totals = JSON.parse(localStorage.getItem('ukTotals')) || { cal: 0, pro: 0 };
        let history = JSON.parse(localStorage.getItem('ukHistory')) || [];
        let goals = JSON.parse(localStorage.getItem('ukGoals')) || { cal: 2000, pro: 50 };

        function updateUI() {
            document.getElementById('txt-cal').innerText = `${Math.round(totals.cal)} / ${goals.cal}`;
            document.getElementById('txt-pro').innerText = `${Math.round(totals.pro)} / ${goals.pro}`;
            document.getElementById('bar-cal').style.width = Math.min((totals.cal / goals.cal) * 100, 100) + '%';
            document.getElementById('bar-pro').style.width = Math.min((totals.pro / goals.pro) * 100, 100) + '%';
            document.getElementById('history-list').innerHTML = history.slice(-5).reverse().map(i => `
                <div class="history-item"><span>${i.name}</span><b>${Math.round(i.cal)} kcal</b></div>
            `).join('');
        }

        function editGoals() {
            goals.cal = prompt("Set Daily Calorie Goal:", goals.cal) || goals.cal;
            goals.pro = prompt("Set Daily Protein Goal (g):", goals.pro) || goals.pro;
            localStorage.setItem('ukGoals', JSON.stringify(goals));
            updateUI();
        }

        function manualAdd() {
            const name = document.getElementById('manual-name').value || "Quick Add";
            const cal = parseFloat(document.getElementById('manual-cal').value) || 0;
            if(cal > 0) {
                totals.cal += cal;
                history.push({name, cal});
                saveAndRefresh();
                document.getElementById('manual-name').value = '';
                document.getElementById('manual-cal').value = '';
            }
        }

        function saveAndRefresh() {
            localStorage.setItem('ukTotals', JSON.stringify(totals));
            localStorage.setItem('ukHistory', JSON.stringify(history));
            updateUI();
        }

        const scanner = new Html5QrcodeScanner("reader", { 
            fps: 20, qrbox: { width: 280, height: 160 },
            videoConstraints: { facingMode: "environment", focusMode: "continuous" }
        });

        scanner.render(async (barcode) => {
            const res = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}?fields=product_name,nutriments,brands`);
            const data = await res.json();
            if (data.status === 1) {
                const p = data.product;
                document.getElementById('result-popup').style.display = 'block';
                document.getElementById('pop-name').innerText = p.product_name || "Unknown";
                document.getElementById('pop-brand').innerText = p.brands || "";
                const calsPer100 = p.nutriments['energy-kcal_100g'] || 0;
                const proPer100 = p.nutriments.proteins_100g || 0;
                document.getElementById('val-cal').innerText = Math.round(calsPer100);
                document.getElementById('val-pro').innerText = proPer100;

                document.getElementById('add-btn').onclick = () => {
                    const mult = parseFloat(document.getElementById('weight-mult').value) || 1;
                    totals.cal += (calsPer100 * mult);
                    totals.pro += (proPer100 * mult);
                    history.push({name: p.product_name, cal: (calsPer100 * mult)});
                    saveAndRefresh();
                    document.getElementById('result-popup').style.display = 'none';
                    document.getElementById('weight-mult').value = 1;
                };
            }
        });

        updateUI();
    </script>
</body>
</html>
