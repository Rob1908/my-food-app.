// Locate the 'onScanSuccess' function in your code and update it to this:

async function onScanSuccess(barcode) {
    // ðŸ“³ HAPTIC FEEDBACK: Short, sharp buzz (200 milliseconds)
    if (navigator.vibrate) {
        navigator.vibrate(200); 
    }

    const popup = document.getElementById('result-popup');
    popup.style.display = 'block';
    document.getElementById('pop-name').innerText = "Searching UK Database...";

    try {
        const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}?fields=product_name,nutriments,brands`);
        const data = await response.json();

        if (data.status === 1) {
            const p = data.product;
            const n = p.nutriments;
            
            // Standardizing the nutrition grab
            const vals = {
                cal: n['energy-kcal_100g'] || 0,
                pro: n.proteins_100g || 0,
                carb: n.carbohydrates_100g || 0,
                fat: n.fat_100g || 0
            };

            document.getElementById('pop-name').innerText = p.product_name || "Unknown Item";
            document.getElementById('val-cal').innerText = Math.round(vals.cal);
            document.getElementById('val-pro').innerText = vals.pro;
            document.getElementById('val-carb').innerText = vals.carb;
            document.getElementById('val-fat').innerText = vals.fat;

            document.getElementById('add-btn').onclick = () => {
                const m = parseFloat(document.getElementById('weight-mult').value) || 1;
                log[today].cal += (vals.cal * m);
                log[today].pro += (vals.pro * m);
                log[today].carb += (vals.carb * m);
                log[today].fat += (vals.fat * m);
                log[today].items.push({name: p.product_name, cal: (vals.cal * m)});
                
                // ðŸ“³ Second buzz to confirm 'Add' button was pressed
                if (navigator.vibrate) navigator.vibrate(50);
                
                save();
                document.getElementById('result-popup').style.display = 'none';
                document.getElementById('weight-mult').value = 1;
            };
        } else {
            document.getElementById('pop-name').innerText = "Product Not Found";
        }
    } catch (e) { 
        console.log(e); 
        document.getElementById('pop-name').innerText = "Network Error";
    }
}
